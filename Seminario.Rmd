---
title: "Impacto de las TIC en la Salud Mental"
output: 
  html_document:
    css: "style.css" 
    toc: true
    toc_depth: 6
    toc_float: true
    theme: flatly
    highlight: tango
    
      

date: "`r format(Sys.Date(), '%d de %B de %Y')`"

author: "Iván Vallejo Cabrero y Diego Ugarte López"

---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Paquetes empleados

```{r message=FALSE, warning=FALSE}

# Cargamos los paquetes

library(tidyverse)
library(dplyr)
library(readr)
library(tidyr)
library(ggplot2)
library(ggthemes)
library(ggtext)
library(ggrepel)
library(ggforce)
library(patchwork)
library(sf)
library(mapSpain)
library(plotly)
library(jsonlite)
library(stringr)

```


```{r warning=FALSE, message=FALSE}
load("OUTPUT/Enviroment_total.RData")
```

<br>

## 1. Introducción

En nuestro seminario analizaremos cómo **factores tecnológicos** impactan en la **salud mental** a nivel de España. 

> **Pregunta 1:** ¿Cuál es el perfil de la población más digitalizada en España y cuál es el perfil de la población con más problemas de salud mental?
    

Utilizaremos datos procesados con **R**, provenientes de la siguiente fuente oficial:

* *Encuesta sobre Equipamiento y Uso de Tecnologías (TIC) del INE.*

--- 

<br>


## 2. Contexto de Salud Mental

Para entender la magnitud del problema, primero analizamos la distribución de la depresión según los siguientes factores.

**Depresión por Situación Laboral y Sexo**

Se representa en el eje x el porcentaje de cuadros depresivos, en el eje y la situación laboral y se dividen los resultados en hombres y mujeres.

En el siguiente gráfico vemos datos depresivos mayores en mujeres que en hombres.


> Dato Crítico: El grupo de Desempleo presenta las tasas más altas de Cuadro Depresivo Mayor, superando significativamente al grupo que trabaja .

<br>

```{r warning=FALSE, message=FALSE}
  # Código extraído de: Tabla_situacion_laboral.R y Grafico_situacion_laboral.R
  
  
  # Tabla
  datos_grafico_estudios <- mis_datos_salud_mental$depresion_actividad_economica %>%
  
  mutate(
  Porcentaje = parse_number(Total, locale = locale(decimal_mark = ","))
    ) %>%
  
  filter(
    Sexo != "Ambos sexos",
    Actividad.económica != "TOTAL",        
    Prevalencia.depresión %in% c("Cuadro depresivo mayor", "Otros cuadros depresivos")
  )

  
  # Gráfico
  
 g_actividad_apilado <- ggplot(datos_grafico_estudios,
                              aes(x = reorder(Actividad.económica, Porcentaje), 
                                  y = Porcentaje, 
                                  fill = Prevalencia.depresión)) +
  

  geom_bar(stat = "identity") + 
  
  geom_text(
    aes(label = paste0(round(Porcentaje, 1), "%")), 
    
    position = position_stack(vjust = 0.5),
    
    color = "black", 
    size = 2,        
    fontface = "bold"
  )+
  
  facet_wrap(~ Sexo) +
  

  coord_flip() + 
  
  labs(
    title = "Depresión por Situación Laboral y Sexo",
    x = "", # Dejamos vacío porque los nombres de actividad ya describen el eje
    y = "Porcentaje Total (%)",
    fill = "Diagnóstico"
  ) +
  
  scale_fill_brewer(palette = "Blues") +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    plot.title = element_text(face = "bold")
  )

print(g_actividad_apilado)

```

<br>

**Intensidad de la Depresión por nivel de estudios**

Analizamos la gravedad de la depresión en función de los estudios.

* Vemos de nuevo que la depresión afecta más al grupo de las mujeres que al grupo de los hombres.
* También vemos como a mayor nivel de estudios, menor porcentaje de depresión.

> Dato Crítico: Personas que tienen un nivel de estudios inferior, son las que más cuadros depresivos padecen.

<br>

```{r warning=FALSE, message=FALSE}

# Código extraído de: Tabla_nivel_estudios.R y Grafico_nivel_estudios.R

tabla_nivel_estudios <- nivel_estudios_parseado %>%
  tidyr::separate(
    col = Nombre,
    into = c("Sexo", "Edad", "Nivel_de_estudios", "Prevalencia_depresion"), 
    sep = ", "
  ) %>% 
  rename(Porcentaje = Valor) %>%  
  select(-Secreto)

datos_grafico_estudios <- tabla_nivel_estudios %>%
  filter(
    Sexo != "Ambos sexos",
    Nivel_de_estudios != "Total",
    Edad == "TOTAL", 
    
    Prevalencia_depresion %in% c("Cuadro depresivo mayor", "Otros cuadros depresivos")
  ) %>% 
  mutate(Nivel_de_estudios= factor(
    Nivel_de_estudios, levels = c("TOTAL", "Básico e inferior", "Intermedio","Superior" )
    )
  )

grafico_nivel_estudios<- ggplot(datos_grafico_estudios,
                             aes(x = Nivel_de_estudios,
                                 y = Porcentaje, 
                                 fill = Prevalencia_depresion)) +
  geom_col() + 
  facet_wrap(~ Sexo) + 
  coord_flip() + 
  labs(
    title = "Depresión por Nivel de Estudios y Sexo",
    subtitle = "Cuadro depresivo mayor y Otros cuadros depresivos",
    x = "Nivel de Estudios",
    y = "Porcentaje Total de Prevalencia (%)",
    fill = "Prevalencia"
  ) +
  scale_fill_brewer(palette = "Blues") +
  theme_minimal()

print(grafico_nivel_estudios)
```

<br>

## 3. Uso de las TICS por comunidades autónomas.

Vamos a ver la distribución de las TIC sobre el territorio español.

Hemos unificado los datos de niños, adultos y mayores para crear un "Índice Digital"

Las zonas más oscuras es donde más uso de las TICs hay, las zonas menos claras tienen un menor uso de estas.

<br>

>**Instrucciones:** Pase el ratón por encima de cada comunidad para ver el las etiquetas de cada comunidad de uso de internet por grupos de edad.


```{r warning=FALSE, message=FALSE}
# Código extraído de: Mapa_España_TICS.R


mapa_españa_ccaa <- esp_get_ccaa(moveCAN = TRUE)

# Corrección para mapa
uso_tic_total_corregido_mapa <- uso_tic_total %>%
  mutate(
    Comunidad = case_when(
      Comunidad == "Asturias, Principado de"~"Asturias",
      Comunidad == "Balears, Illes" ~ "Baleares",
      Comunidad == "Castilla - La Mancha" ~ "Castilla-La Mancha",
      Comunidad == "Comunitat Valenciana" ~ "Comunidad Valenciana",
      Comunidad == "Madrid, Comunidad de" ~ "Madrid",
      Comunidad == "Murcia, Región de" ~ "Murcia",
      Comunidad == "Navarra, Comunidad Foral de" ~ "Navarra",
      Comunidad == "Rioja, La" ~ "La Rioja",
      TRUE ~ Comunidad
    )
  )

#Join para crear la tabla para representar el mapa

mapa_con_datos <- mapa_españa_ccaa %>%
  left_join(uso_tic_total_corregido_mapa, by = c("ccaa.shortname.es" = "Comunidad"))

#Creación del mapa

datos_mapa_coloreado <- mapa_con_datos %>%
  mutate(
    Uso_Global_Indice = (Frecuencia_Total_Adultos+ Frecuencia_Total_Niños+ Frecuencia_Total_Mayores)/3,
    
    
    tooltip_data = paste0(
      '<b>', ccaa.shortname.es, "</b><br>", 
      "--------------------------<br>",
      "Índice Global: ", round(Uso_Global_Indice, 1), "%<br>",
      "Adultos: ", round(Frecuencia_Total_Adultos, 1), "%<br>",
      "Niños: ", round(Frecuencia_Total_Niños, 1), "%<br>",
      "Mayores: ", round(Frecuencia_Total_Mayores, 1), "%"
    )
  )

mapa_intensidad <- ggplot(data = datos_mapa_coloreado) +
  geom_sf(
    aes(fill = Uso_Global_Indice, text = tooltip_data),
    color = "white", size = 0.2 
  ) +
  geom_sf_text(
    aes(label = ccaa.shortname.es), 
    size = 2,         
    color = "black",     
    fontface = "bold",
    check_overlap = TRUE 
  ) +

  scale_fill_gradient(
    low = "#EBF5FB",   
    high = "#21618C",  
    name = "Intensidad de Uso"
  ) +
  
  theme_void() +
  labs(title = "Intensidad del uso de TICs en España ") +
  theme(
    legend.position = "right",
    plot.title = element_text(hjust = 0.5, face = "bold")
  )

#Para hacer el mapa interactivo

mapa_final_españa <- ggplotly(mapa_intensidad, tooltip = "text") %>%
  style(hoveron = "fills", traces = 1) %>% 
  layout(
    hoverlabel = list(bgcolor = "white", bordercolor = "black", font = list(color = "black"))
  )

mapa_final_españa


```

El resultado se debe al factor de la edad media de cada comunidad autónoma, lo explicaremos en el siguiente gráfico.


Podemos observar que las zonas con mayor densidad de población presentan los índices de uso más altos.

Como conclusión de este mapa vemos que el uso de las TICs se concentra donde hay **más gente** y **más joven**. 

<br>

## 4. Contexto de Uso de TICs

A continuación vamos a definir cual es el perfil de las personas que utilizan las TIC en España, observando en las distintas Comunidades Autónomas y clasificando por edad.

1. **Niños (10-15 años):** 

2. **Adultos (16-74 años):** 

3. **Mayores (75+ años):** 
```{r warning=FALSE, message=FALSE}

# Código extraído de: Mapa_España_TICS.R 

# Corrección nombres
uso_tic_total_corregido <- uso_tic_total %>%
  mutate(
    Comunidad = case_when(
      Comunidad == "Asturias, Principado de"~"Asturias",
      Comunidad == "Balears, Illes" ~ "Baleares",
      Comunidad == "Castilla - La Mancha" ~ "Castilla-La Mancha",
      Comunidad == "Comunitat Valenciana" ~ "Comunidad Valenciana",
      Comunidad == "Madrid, Comunidad de" ~ "Madrid",
      Comunidad == "Murcia, Región de" ~ "Murcia",
      Comunidad == "Navarra, Comunidad Foral de" ~ "Navarra",
      Comunidad == "Rioja, La" ~ "La Rioja",
      TRUE ~ Comunidad
    )
  )

# Pivotaje
uso_tic_total_pivotada <- uso_tic_total_corregido %>% 
  pivot_longer(
    cols= -Comunidad,
    names_to = "Grupo_Edad",
    values_to = "Frecuencia_Total"
  )

orden_grupos <- c("Frecuencia_Total_Niños", "Frecuencia_Total_Adultos", "Frecuencia_Total_Mayores")
names_grupos <- c("Niños (10-15)", "Adultos (16-74)", "Mayores (75+)")

uso_tic_ordenada <- uso_tic_total_pivotada %>% 
  mutate(Grupo_Edad = factor(Grupo_Edad, levels = orden_grupos, labels = names_grupos))

# Gráfico
ggplot(uso_tic_ordenada, aes(x=Comunidad, y=Frecuencia_Total, fill=Grupo_Edad))+
  geom_bar(stat = "identity", position = "dodge")+
  labs(
    title= "Perfil de Uso Frecuente de las TIC por Edad y Comunidad",
    y= "Porcentaje de Uso Promedio (%)",
    x= "",
    fill = "Grupo de Edad")+
  scale_fill_brewer(palette = "Blues") +
  theme_classic()+
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size=10),
    legend.position = "top"
  )
```

## 5. Relación TICs con Depresión por Nivel de Estudios

Analizamos si la **educación** actúa como *factor protector*. El siguiente gráfico de doble eje muestra un cruce revelador:

* <span style="color: #1f77b4"><b>Línea Azul (TICs):</b></span> A mayor nivel educativo, mayor uso de tecnología.

* <span style="color: #d62728"><b>Línea Roja (Depresión):</b></span> A mayor nivel educativo, la depresión cae drásticamente.

```{r warning=FALSE, message=FALSE}
# Código extraído de: Grafico_nivel_estudios.R

# AJUSTE: fig.height=6 y l-body-outset para que las líneas se vean claras.

if(exists("tabla_nivel_estudios_final")){
  
  max_tics <- max(tabla_nivel_estudios_final$Porcentaje_TICS, na.rm = TRUE)
  max_depresion <- max(tabla_nivel_estudios_final$Porcentaje_Depresion, na.rm = TRUE)
  factor_escala <- max_tics / max_depresion

  ggplot(tabla_nivel_estudios_final, 
         aes(x = as.numeric(factor(Nivel_de_estudios, 
                                   levels = c("Básico e inferior", "Intermedio", "Superior"))), 
             group = 1)) +
    
    geom_line(aes(y = Porcentaje_TICS, color = "Uso de TICs"), linewidth = 1.2) +
    geom_point(aes(y = Porcentaje_TICS, color = "Uso de TICs"), size = 4) +
    geom_text(aes(y = Porcentaje_TICS, label = round(Porcentaje_TICS, 1)), vjust = -1.5, fontface="bold") +
    
    geom_line(aes(y = Porcentaje_Depresion * factor_escala, color = "Depresión"), linewidth = 1.2) +
    geom_point(aes(y = Porcentaje_Depresion * factor_escala, color = "Depresión"), size = 4) +
    geom_text(aes(y = Porcentaje_Depresion * factor_escala, label = round(Porcentaje_Depresion, 1)), vjust = 2, fontface="bold") +
    
    scale_y_continuous(
      name = "Uso de TICs (%)",
      sec.axis = sec_axis(~ . / factor_escala, name = "Depresión (%)")
    ) +
    
    scale_x_continuous(
      breaks = 1:3,
      labels = c("Básico e inferior", "Intermedio", "Superior"),
      name = "Nivel de Estudios"
    ) +
    
    scale_color_manual(values = c("Uso de TICs" = "#1f77b4", "Depresión" = "#d62728")) +
    
    labs(
      title = "Nivel de Estudios: Factor Protector",
      subtitle = "Relación inversa entre adopción tecnológica y depresión",
      color = ""
    ) +
    theme_classic() +
    theme(legend.position = "bottom")
}
```

## 6. Relación TICs con Empleabilidad

Finalmente, llegamos a la **"Paradoja Digital"**. A menudo se asume que la conexión digital mejora las oportunidades, pero los datos muestran una realidad más compleja.

Comparamos dos grupos con niveles similares de uso de internet, pero realidades opuestas:

1. **Estudiantes**: Alta conectividad y baja depresión.

2. **Desempleados**: Alta conectividad y <span style="color: #C0392B"><b>Muy alta depresión</b></span>.


```{r relacion_empleabilidad, fig.height=14, fig.width=10, out.width="100%"}

# ==============================================================================
# 1. DATOS SALUD (EMPLEO)
# ==============================================================================
df_salud_empleo <- mis_datos_salud_mental$depresion_actividad_economica %>%
  rename(
    Actividad = `Actividad.económica`,
    Tipo_Depresion = `Prevalencia.depresión`,
    Porcentaje = Total
  ) %>%
  filter(
    Sexo == "Ambos sexos",
    Tipo_Depresion == "Cuadro depresivo mayor",
    Actividad != "TOTAL"
  ) %>%
  mutate(
    Tasa_Depresion = parse_number(Porcentaje, locale = locale(decimal_mark = ",")),
    Situacion_laboral = case_when(
      Actividad %in% c("Parado/a", "Parados", "En desempleo", "Desempleado") ~ "En desempleo",
      Actividad == "Jubilado/a o prejubilado/a" ~ "Jubilado/Pensionista",
      Actividad == "Labores del hogar" ~ "Labores del hogar",
      Actividad == "Incapacitado/a para trabajar" ~ "Incapacitado",
      Actividad == "Estudiando" ~ "Estudiando",
      Actividad == "Trabajando" ~ "Trabajando",
      TRUE ~ "Otros"
    )
  )

# ==============================================================================
# 2. DATOS TIC (Uso de Internet)
# ==============================================================================
lista_frecuencias <- c(
  "Han usado Internet diariamente (al menos 5 días a la semana)",
  "Han utilizado internet varias veces al día"
)

df_tic_empleo <- mis_datos_tic$uso_internet_socioeconomico %>%
  rename(
    Grupo = Clase.de.población, 
    Características = Características.socioeconómicas, 
    Frecuencia = Frecuencia.de.uso, 
    Total_TIC = Total
  ) %>%
  filter(
    Grupo == "Total de personas (16 a 74 años)",
    Frecuencia %in% lista_frecuencias
  ) %>%
  mutate(
    Tasa_Internet = parse_number(Total_TIC, locale = locale(decimal_mark = ",")),
    Situacion_laboral = case_when(
      Características == "Situación laboral: Activos ocupados" ~ "Trabajando",
      Características == "Situación laboral: Activos parados" ~ "En desempleo",
      Características == "Situación laboral: Inactivos: Estudiantes" ~ "Estudiando",
      Características == "Situación laboral: Inactivos: Pensionistas" ~ "Jubilado/Pensionista",
      Características == "Situación laboral: Inactivos: Labores del hogar" ~ "Labores del hogar",
      TRUE ~ "Otros"
    )
  ) %>%
  group_by(Situacion_laboral) %>%
  summarise(Tasa_Internet = mean(Tasa_Internet, na.rm = TRUE))

# ==============================================================================
# 3. UNIÓN FINAL
# ==============================================================================
df_final <- left_join(df_salud_empleo, df_tic_empleo, by = "Situacion_laboral") %>%
  filter(!is.na(Tasa_Internet)) %>% 
  select(Situacion_laboral, Tasa_Depresion, Tasa_Internet, Actividad)

# ==============================================================================
# 4. GRAFICO SALUD EMPLEO
# ==============================================================================
grafico_salud_empleo <- df_salud_empleo %>% 
  ggplot(mapping = aes(x = reorder(Actividad, -Tasa_Depresion), y = Tasa_Depresion)) +
  
  geom_bar(stat = "identity", aes(fill = Tasa_Depresion == max(Tasa_Depresion)), width = 0.7, alpha = 0.9) +
  
  geom_text(aes(label = paste0(Tasa_Depresion, "%")), 
            hjust = -0.2, 
            fontface = "bold", 
            colour = "#2C3E50", 
            size = 4.5) +
  
  scale_fill_manual(values = c("FALSE" = "#EBF5FB", "TRUE" = "#21618C"), guide = "none") +
  
  scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 25)) +
  scale_y_continuous(expand = expansion(mult = c(0, .15))) + 
  
  coord_flip() + 
  
  labs(
    x = NULL, 
    y = "Tasa de Depresión (%)",
    title = "A. Salud Mental por Situación Laboral",
    subtitle = "El desempleo es el factor más crítico."
  ) +
  
  theme_classic() +
  theme(
    plot.title = element_text(face = "bold", size = 16, hjust = 0),
    axis.text.y = element_text(size = 11, face = "bold", color = "black"), 
    axis.text.x = element_blank(), 
    axis.ticks = element_blank(),
    axis.line.x = element_blank()
  )

# ==============================================================================
# 5. GRÁFICO SALUD EMPLEO CON TICS
# ==============================================================================
grafico_depresion_tics_empleo <- df_final %>% 
  mutate(Grupo = case_when(
    Situacion_laboral == "Estudiando" ~ "Estudiantes",
    Situacion_laboral == "En desempleo" ~ "Parados",
    TRUE ~ "Otros" 
  )) %>% 
  
  ggplot(aes(x = Tasa_Internet, y = Tasa_Depresion)) +
  
  geom_smooth(method = "lm", se = FALSE, color = "black", size = 1, linetype = "dashed") +
  
  geom_point(aes(fill = Grupo), size = 6, shape = 21, color = "white", stroke = 1.5) +
  
  geom_text_repel(aes(label = Situacion_laboral), 
                  size = 5, 
                  color = "grey40",
                  point.padding = 0.5,
                  box.padding = 0.5) +
  
  scale_fill_manual(values = c("Estudiantes" = "#F28E2B", 
                               "Parados" = "#21618C",      
                               "Otros" = "#EBF5FB")) +      
  
  labs(
    title = "B. La Paradoja Digital",
    subtitle = "Comparativa: Estudiantes vs Parados",
    x = "Uso Diario de Internet (%)", 
    y = "Depresión Mayor (%)"
  ) +
  
  theme_classic() +
  theme(
    plot.title = element_text(face = "bold", size = 16),
    plot.subtitle = element_text(size = 12, color = "grey30"),
    axis.text = element_text(face = "bold", size = 10),
    legend.position = "none"
  )

# ==============================================================================
# 6. COMPOSICIÓN FINAL (PATCHWORK)
# ==============================================================================
composicion_graficos_empleo <- grafico_salud_empleo / grafico_depresion_tics_empleo + 
  plot_annotation(
    title = 'IMPACTO DEL TRABAJO Y LA BRECHA DIGITAL EN LA SALUD MENTAL',
    theme = theme(plot.title = element_text(size = 20, face = "bold", hjust = 0.5))
  )

print(composicion_graficos_empleo)
```